name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run smoke validation
        run: |
          python3 scripts/smoke_check.py --include-fairness --json-out smoke_summary.json

      - name: Build release artifact bundle
        run: |
          mkdir -p release-artifacts
          cp baseline_metrics.json release-artifacts/
          cp classification_metrics.json release-artifacts/
          cp benchmark_metrics.json release-artifacts/
          cp fairness_metrics.json release-artifacts/
          cp utility_fedavg_metrics.json release-artifacts/
          cp utility_fairness_metrics.json release-artifacts/
          cp adapter_intent_metrics.json release-artifacts/
          cp generality_metrics.json release-artifacts/
          cp reproducibility_metrics.json release-artifacts/
          cp smoke_summary.json release-artifacts/
          cp CHANGELOG.md release-artifacts/
          cp DECISION_LOG.md release-artifacts/
          cp PROVENANCE_TEMPLATE.md release-artifacts/
          sha256sum release-artifacts/* > release-artifacts/SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: release-artifacts/*
